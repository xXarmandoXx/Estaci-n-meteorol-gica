<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estación Meteorológica | Armando G.</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Clima Mando">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/480/clouds.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- 1. VARIABLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg-body: #0f172a; 
            --bg-sidebar: #020617;
            --glass-card: rgba(30, 41, 59, 0.7); 
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --neon-blue: #38bdf8;
            --neon-pink: #f472b6;   /* DHT11 */
            --neon-orange: #fb923c; /* TERMISTOR */
            --neon-green: #34d399;
            --neon-red: #ef4444; 
            --neon-purple: #c084fc;
            
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            
            --transition: all 0.3s ease;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-body); 
            background-image: radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.05) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(244, 114, 182, 0.05) 0%, transparent 20%);
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
        }

        /* --- 2. SIDEBAR --- */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; z-index: 100; }
        
        .brand-section { margin-bottom: 40px; display: flex; flex-direction: column; gap: 8px; }
        .brand-logo-container { display: flex; align-items: center; gap: 12px; }
        .brand-icon { font-size: 1.8rem; color: var(--neon-blue); filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.3)); }
        .brand-text { display: flex; flex-direction: column; line-height: 1.2; }
        .brand-title-main { font-size: 1rem; font-weight: 700; color: white; letter-spacing: 0.5px; }
        .brand-subtitle { font-size: 0.8rem; color: var(--neon-blue); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .author-credit-pc { font-size: 0.7rem; color: var(--text-muted); opacity: 0.6; margin-left: 5px; font-weight: 400; }
        .mobile-footer-credit { display: none; }

        .menu-items { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; margin-top: 10px; }
        .menu-btn { padding: 14px 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: var(--text-muted); transition: var(--transition); font-weight: 500; font-size: 0.95rem; }
        .menu-btn:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .menu-btn.active { background: linear-gradient(90deg, rgba(56, 189, 248, 0.15), transparent); color: var(--neon-blue); border-left: 3px solid var(--neon-blue); }
        .menu-btn.active i { color: var(--neon-blue); }
        .sidebar-footer { margin-top: auto; font-size: 0.7rem; color: var(--text-muted); text-align: center; opacity: 0.4; }

        /* --- 3. CONTENIDO PRINCIPAL --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header-top { padding: 25px 40px; display: flex; justify-content: space-between; align-items: center; }
        .header-info h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .header-info p { color: var(--text-muted); font-size: 0.9rem; }

        .status-badge { 
            padding: 6px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; transition: var(--transition);
        }
        .status-online { background: rgba(52, 211, 153, 0.1); color: var(--neon-green); border: 1px solid rgba(52, 211, 153, 0.3); }
        .status-offline { background: rgba(239, 68, 68, 0.1); color: var(--neon-red); border: 1px solid rgba(239, 68, 68, 0.3); }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-online { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); animation: pulse-green 2s infinite; }
        .dot-offline { background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }
        @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .content-area { flex-grow: 1; overflow-y: auto; padding: 10px 40px 40px 40px; -webkit-overflow-scrolling: touch; }
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .offline-banner {
            background: rgba(239, 68, 68, 0.15); border: 1px solid var(--neon-red); color: #fca5a5;
            padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none;
            align-items: center; gap: 10px; font-size: 0.9rem;
        }

        /* --- 4. COMPONENTES Y TARJETAS --- */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .glass-card { background: var(--glass-card); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 25px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); transition: var(--transition); }
        .glass-card.warning { border: 1px solid var(--neon-red); box-shadow: 0 0 25px rgba(239, 68, 68, 0.3); animation: pulse-red 2s infinite; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .icon-box { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .icon-temp { background: rgba(244, 114, 182, 0.15); color: var(--neon-pink); }
        .icon-hum { background: rgba(56, 189, 248, 0.15); color: var(--neon-blue); }
        .icon-rain { background: rgba(192, 132, 252, 0.15); color: var(--neon-purple); }
        .icon-stat { background: rgba(52, 211, 153, 0.15); color: var(--neon-green); }
        .icon-off { background: rgba(100, 116, 139, 0.3); color: var(--text-muted); }

        .big-value { font-size: 3.5rem; font-weight: 700; color: white; line-height: 1; }
        .unit { font-size: 1.2rem; color: var(--text-muted); font-weight: 400; margin-left: 5px; }
        .sub-text { font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; display:flex; justify-content: space-between; }
        .record-date { display: block; font-size: 0.75rem; color: var(--neon-blue); margin-top: 5px; font-weight: 500; opacity: 0.8; }

        /* --- NUEVO: ESTILOS PARA LA TARJETA DUAL DE TEMPERATURA --- */
        .dual-temp-container { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .temp-box { width: 48%; display: flex; flex-direction: column; align-items: center; }
        .temp-divider { width: 1px; height: 50px; background: rgba(255,255,255,0.1); }
        
        .val-dual { font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .lbl-dual { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; text-transform: uppercase; letter-spacing: 1px; }
        
        .color-dht { color: var(--neon-pink); }
        .color-ntc { color: var(--neon-orange); }

        .chart-wrapper { height: 350px; position: relative; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 15px; color: var(--text-muted); border-bottom: 1px solid var(--glass-border); font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: var(--text-main); }
        tr:hover { background: rgba(255,255,255,0.02); }

        .toggle-group { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; display: inline-flex; margin-bottom: 25px; }
        .toggle-btn { padding: 8px 20px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .toggle-btn.active { background: var(--glass-border); color: white; }

        .config-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 15px; border-radius: 12px; font-size: 1rem; margin-bottom: 20px; }
        .btn-neon { width: 100%; background: linear-gradient(90deg, var(--neon-blue), #2563eb); border: none; padding: 15px; color: white; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
        
        /* Botones de descarga */
        .btn-download { 
            border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; 
            font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; 
            transition: 0.2s; background: var(--neon-green); color: #064e3b; 
        }
        .btn-download:hover { background: #6ee7b7; box-shadow: 0 0 10px rgba(52, 211, 153, 0.4); }

        /* --- 5. IPHONE / MÓVIL --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; height: 75px; position: fixed; top: 0; left: 0; 
                flex-direction: row; padding: 0 15px; justify-content: space-between; align-items: center;
                background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px);
                border-right: none; border-bottom: 1px solid var(--glass-border);
            }
            .brand-section { margin-bottom: 0; gap: 0; }
            .brand-logo-container { gap: 8px; }
            .brand-icon { font-size: 1.4rem; }
            .brand-title-main { font-size: 0.9rem; }
            .brand-subtitle { font-size: 0.7rem; }
            .author-credit-pc { display: none; }
            
            .mobile-footer-credit {
                display: block; text-align: center; margin-top: 30px; padding: 20px;
                color: var(--text-muted); font-size: 0.8rem; opacity: 0.7;
                border-top: 1px solid var(--glass-border);
            }

            .menu-items { flex-direction: row; flex-grow: 0; gap: 2px; margin-top: 0; }
            .menu-btn { padding: 8px; border-radius: 8px; flex-direction: column; gap: 0; font-size: 0.7rem; background: transparent !important; border: none !important; }
            .menu-btn i { font-size: 1.2rem; margin-bottom: 2px; }
            .menu-btn span { display: none; }
            .menu-btn.active i { color: var(--neon-blue); text-shadow: 0 0 10px rgba(56,189,248,0.6); }
            .sidebar-footer { display: none; }

            .main-content { margin-top: 75px; height: calc(100vh - 75px); }
            .header-top { padding: 20px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .content-area { padding: 15px; }
            .chart-wrapper { height: 280px; }
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand-section">
            <div class="brand-logo-container">
                <i class="fa-solid fa-cloud-sun brand-icon"></i>
                <div class="brand-text">
                    <span class="brand-title-main">Estación</span>
                    <span class="brand-subtitle">Meteorológica</span>
                </div>
            </div>
            <div class="author-credit-pc">Dev: Armando Gutierrez</div>
        </div>

        <div class="menu-items">
            <div class="menu-btn active" onclick="switchView('dashboard', this)">
                <i class="fa-solid fa-chart-pie"></i> <span>Monitor</span>
            </div>
            <div class="menu-btn" onclick="switchView('historial', this)">
                <i class="fa-solid fa-database"></i> <span>Datos</span>
            </div>
            <div class="menu-btn" onclick="switchView('analisis', this)">
                <i class="fa-solid fa-chart-simple"></i> <span>Stats</span>
            </div>
            <div class="menu-btn" onclick="switchView('config', this)">
                <i class="fa-solid fa-sliders"></i> <span>Ajustes</span>
            </div>
        </div>

        <div class="sidebar-footer">v8.4 Dual Precision</div>
    </nav>

    <main class="main-content">
        <div class="header-top">
            <div class="header-info">
                <h1 id="page-title">Dashboard</h1>
                <p id="page-subtitle">Monitoreo en Tiempo Real</p>
            </div>
            <div id="status-badge" class="status-badge status-online">
                <div id="status-dot" class="dot dot-online"></div>
                <span id="status-text">ONLINE</span>
            </div>
        </div>

        <div class="content-area">

            <div id="offline-banner" class="offline-banner">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span><strong>ATENCIÓN:</strong> El sensor no ha enviado datos recientemente. Verifique la conexión o energía.</span>
            </div>

            <section id="dashboard" class="view-section active">
                <div class="metrics-grid">
                    
                    <div class="glass-card">
                        <div class="card-header">
                            <span class="card-label">Comparativa Sensores</span>
                            <div class="icon-box icon-temp"><i class="fa-solid fa-temperature-half"></i></div>
                        </div>
                        
                        <div class="dual-temp-container">
                            <div class="temp-box">
                                <span id="temp-val" class="val-dual color-dht">--</span>
                                <span class="lbl-dual">DHT11 (Digital)</span>
                            </div>
                            
                            <div class="temp-divider"></div>
                            
                            <div class="temp-box">
                                <span id="temp-ntc-val" class="val-dual color-ntc">--</span>
                                <span class="lbl-dual">Termistor (NTC)</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <div class="card-header">
                            <span class="card-label">Humedad</span>
                            <div class="icon-box icon-hum"><i class="fa-solid fa-droplet"></i></div>
                        </div>
                        <div class="big-value" style="color: var(--neon-blue);">
                            <span id="hum-val">--</span><span class="unit">%</span>
                        </div>
                        <div class="sub-text">Humedad Relativa</div>
                    </div>

                    <div class="glass-card">
                        <div class="card-header">
                            <span class="card-label">Lluvia Total</span>
                            <div class="icon-box icon-rain"><i class="fa-solid fa-cloud-rain"></i></div>
                        </div>
                        <div class="big-value" style="color: var(--neon-purple);">
                            <span id="rain-val">--</span><span class="unit">mm</span>
                        </div>
                        <div class="sub-text">Acumulado Sesión</div>
                    </div>

                    <div class="glass-card">
                        <div class="card-header">
                            <span class="card-label">Estado Señal</span>
                            <div id="signal-icon" class="icon-box icon-stat"><i class="fa-solid fa-wifi"></i></div>
                        </div>
                        <div class="big-value" style="font-size: 1.8rem; margin-top: 10px; color: var(--neon-green);" id="connection-status">
                            CONECTADO
                        </div>
                        <div class="sub-text" id="last-seen-text">Sincronizado ahora</div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <span class="card-label" style="color:white;">Comparativa Gráfica: DHT11 vs NTC</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="historial" class="view-section">
                <div class="glass-card">
                    <div class="card-header">
                        <span class="card-label">Últimos Registros</span>
                        <button class="btn-download" onclick="downloadFullCSV()">
                            <i class="fa-solid fa-file-excel"></i> Reporte Completo
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead><tr><th>Hora</th><th>DHT11</th><th>Termistor</th><th>Hum</th><th>Lluvia</th></tr></thead>
                            <tbody id="history-body">
                                <tr><td colspan="5" style="text-align:center; padding:20px;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="analisis" class="view-section">
                <div class="toggle-group">
                    <button class="toggle-btn active" id="btn-temp" onclick="switchAnalysisMode('temp')">Temperatura</button>
                    <button class="toggle-btn" id="btn-hum" onclick="switchAnalysisMode('hum')">Humedad</button>
                </div>

                <div class="metrics-grid">
                    <div class="glass-card">
                        <div class="card-header"><span class="card-label">Máxima Registrada</span></div>
                        <div class="big-value" style="font-size: 2.5rem;"><span id="max-stat">--</span><span class="unit" id="unit-1"></span></div>
                        <span class="record-date" id="max-date">--/-- --:--</span>
                    </div>
                    <div class="glass-card">
                        <div class="card-header"><span class="card-label">Mínima Registrada</span></div>
                        <div class="big-value" style="font-size: 2.5rem;"><span id="min-stat">--</span><span class="unit" id="unit-2"></span></div>
                        <span class="record-date" id="min-date">--/-- --:--</span>
                    </div>
                    <div class="glass-card">
                        <div class="card-header"><span class="card-label">Promedio General</span></div>
                        <div class="big-value" style="font-size: 2.5rem;"><span id="avg-stat">--</span><span class="unit" id="unit-3"></span></div>
                        <span class="sub-text">Últimas 20 lecturas</span>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header"><span class="card-label">Distribución Estadística</span></div>
                    <div class="chart-wrapper">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="config" class="view-section">
                <div class="glass-card" style="max-width: 500px;">
                    <div class="card-header"><span class="card-label">Configuración de Alertas</span></div>
                    
                    <label style="display:block; margin-bottom:10px; color:var(--text-muted);">Alerta Temperatura (°C)</label>
                    <input type="number" id="temp-threshold" class="config-input" value="35">
                    
                    <label style="display:block; margin-bottom:10px; color:var(--text-muted);">Alerta Humedad (%)</label>
                    <input type="number" id="hum-threshold" class="config-input" value="70">

                    <button class="btn-neon" onclick="saveConfig()">Guardar Cambios</button>
                </div>
            </section>

            <div class="mobile-footer-credit">
                Desarrollado por: <strong>Armando Gutierrez</strong>
            </div>

        </div>
    </main>

<script>
    const firebaseConfig = { databaseURL: "https://estacion-texcoco-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const appState = {
        currentView: 'dashboard',
        tempThreshold: 35,
        humThreshold: 70,
        fullHistory: [], 
        analysisMode: 'temp',
        lastTimestamp: 0,
        charts: {}
    };

    function switchView(viewId, btn) {
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(viewId).classList.add('active');
        const titles = { dashboard: 'Dashboard', historial: 'Base de Datos', analisis: 'Estadísticas', config: 'Configuración' };
        document.getElementById('page-title').innerText = titles[viewId];
        if(viewId === 'analisis' && appState.charts.stats) setTimeout(() => appState.charts.stats.resize(), 100);
    }

    function initCharts() {
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

        const ctxTemp = document.getElementById('tempChart').getContext('2d');
        
        const gradPink = ctxTemp.createLinearGradient(0,0,0,300);
        gradPink.addColorStop(0, 'rgba(244, 114, 182, 0.4)');
        gradPink.addColorStop(1, 'rgba(244, 114, 182, 0)');

        const gradOrange = ctxTemp.createLinearGradient(0,0,0,300);
        gradOrange.addColorStop(0, 'rgba(251, 146, 60, 0.4)');
        gradOrange.addColorStop(1, 'rgba(251, 146, 60, 0)');

        appState.charts.temp = new Chart(ctxTemp, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [
                    { label: 'DHT11', data: [], borderColor: '#f472b6', backgroundColor: gradPink, borderWidth: 3, tension: 0.4, fill: true, pointRadius: 0 },
                    { label: 'Termistor', data: [], borderColor: '#fb923c', backgroundColor: gradOrange, borderWidth: 3, tension: 0.4, fill: true, pointRadius: 0 }
                ] 
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: true, labels: { color: 'white' } } }, 
                scales: { x: { display: false } },
                interaction: { mode: 'index', intersect: false }
            }
        });

        const ctxStats = document.getElementById('statsChart');
        appState.charts.stats = new Chart(ctxStats, {
            type: 'bar',
            data: { labels: ['Min', 'Prom', 'Max'], datasets: [{ data: [0,0,0], backgroundColor: ['#38bdf8', '#818cf8', '#c084fc'], borderRadius: 10 }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } }
        });
    }

    function checkSystemHealth() {
        if (appState.lastTimestamp === 0) return;
        const diffMinutes = (Date.now() - appState.lastTimestamp) / 1000 / 60;
        const badge = document.getElementById('status-badge');
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        const banner = document.getElementById('offline-banner');
        const connStatus = document.getElementById('connection-status');
        const icon = document.getElementById('signal-icon');

        if (diffMinutes > 15) { 
            badge.className = "status-badge status-offline"; dot.className = "dot dot-offline"; text.innerText = "OFFLINE";
            banner.style.display = "flex"; connStatus.innerText = "DESCONECTADO"; connStatus.style.color = "var(--neon-red)"; icon.className = "icon-box icon-off";
        } else { 
            badge.className = "status-badge status-online"; dot.className = "dot dot-online"; text.innerText = "ONLINE";
            banner.style.display = "none"; connStatus.innerText = "CONECTADO"; connStatus.style.color = "var(--neon-green)"; icon.className = "icon-box icon-stat";
        }
    }
    setInterval(checkSystemHealth, 60000);

    function switchAnalysisMode(mode) {
        appState.analysisMode = mode;
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode === 'temp' ? 'btn-temp' : 'btn-hum').classList.add('active');
        updateAnalysisUI();
    }

    function updateAnalysisUI() {
        const mode = appState.analysisMode;
        const unit = mode === 'temp' ? '°C' : '%';
        const data = appState.fullHistory;
        document.getElementById('unit-1').innerText = unit;
        document.getElementById('unit-2').innerText = unit;
        document.getElementById('unit-3').innerText = unit;
        if(data.length === 0) return;

        const cleanData = data.map(d => ({
            val: parseFloat(mode === 'temp' ? (d.t_dht || d.temperatura) : d.humedad),
            date: new Date(d.fecha)
        })).filter(d => !isNaN(d.val));

        if(cleanData.length === 0) return;
        const maxObj = cleanData.reduce((prev, curr) => (curr.val > prev.val) ? curr : prev);
        const minObj = cleanData.reduce((prev, curr) => (curr.val < prev.val) ? curr : prev);
        const avg = (cleanData.reduce((acc, curr) => acc + curr.val, 0) / cleanData.length).toFixed(1);
        const formatDate = (date) => date.toLocaleString("es-MX", {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});

        document.getElementById('max-stat').innerText = maxObj.val.toFixed(1);
        document.getElementById('max-date').innerText = "Reg: " + formatDate(maxObj.date);
        document.getElementById('min-stat').innerText = minObj.val.toFixed(1);
        document.getElementById('min-date').innerText = "Reg: " + formatDate(minObj.date);
        document.getElementById('avg-stat').innerText = avg;
        if(appState.charts.stats) { 
            appState.charts.stats.data.datasets[0].data = [minObj.val, avg, maxObj.val]; 
            appState.charts.stats.update(); 
        }
    }

    // --- LOGICA PRINCIPAL FIREBASE ---
    db.ref('/historial').limitToLast(30).on('value', snap => {
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = "";
        let labels = [], dataDHT = [], dataNTC = [], rows = [];
        appState.fullHistory = []; 

        let lastEntryTime = 0, lastDHT = 0, lastNTC = 0, lastHum = 0, lastRain = 0;

        snap.forEach(child => {
            const val = child.val();
            if(val.fecha) {
                const dateObj = new Date(val.fecha);
                const timeStr = dateObj.toLocaleTimeString("es-MX", {hour:'2-digit', minute:'2-digit'});
                lastEntryTime = dateObj.getTime();
                
                let tempDHT = val.t_dht !== undefined ? val.t_dht : val.temperatura;
                let tempNTC = val.t_termistor !== undefined ? val.t_termistor : 0;

                lastDHT = tempDHT;
                lastNTC = tempNTC;
                lastHum = val.humedad;
                lastRain = (val.mm_total !== undefined) ? val.mm_total : 0; 

                labels.push(timeStr);
                dataDHT.push(tempDHT);
                dataNTC.push(tempNTC);
                appState.fullHistory.push(val);

                // TABLA: AQUI MOSTRAMOS 2 DECIMALES PARA TERMISTOR
                rows.unshift(`<tr>
                    <td style="color:#f1f5f9;">${timeStr}</td>
                    <td style="color:#f472b6; font-weight:bold;">${tempDHT ? parseFloat(tempDHT).toFixed(1) : '--'}°</td>
                    <td style="color:#fb923c; font-weight:bold;">${tempNTC ? parseFloat(tempNTC).toFixed(2) : '--'}°</td>
                    <td style="color:#38bdf8">${val.humedad ? val.humedad : '--'}%</td>
                    <td style="color:#c084fc;">${lastRain.toFixed(1)} mm</td>
                </tr>`);
            }
        });

        // ACTUALIZACION DE TARJETAS EN VIVO
        if (lastEntryTime > 0) {
            if(lastDHT) document.getElementById('temp-val').innerText = parseFloat(lastDHT).toFixed(1);
            
            // --- CAMBIO CLAVE AQUI PARA EL TERMISTOR ---
            if(lastNTC) document.getElementById('temp-ntc-val').innerText = parseFloat(lastNTC).toFixed(2); 

            if(lastHum) document.getElementById('hum-val').innerText = parseFloat(lastHum).toFixed(0);
            document.getElementById('rain-val').innerText = parseFloat(lastRain).toFixed(1);
            
            const fullDateStr = new Date(lastEntryTime).toLocaleString("es-MX", {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
            document.getElementById('last-seen-text').innerText = "Último: " + fullDateStr;

            appState.lastTimestamp = lastEntryTime;
            checkSystemHealth(); 
        }

        tbody.innerHTML = rows.join("");
        if(appState.charts.temp) { 
            appState.charts.temp.data.labels = labels; 
            appState.charts.temp.data.datasets[0].data = dataDHT; 
            appState.charts.temp.data.datasets[1].data = dataNTC; 
            appState.charts.temp.update(); 
        }
        updateAnalysisUI();
    });

    function saveConfig() {
        appState.tempThreshold = parseFloat(document.getElementById('temp-threshold').value);
        appState.humThreshold = parseFloat(document.getElementById('hum-threshold').value);
        const btn = document.querySelector('.btn-neon');
        btn.innerText = "¡Configuración Guardada!";
        setTimeout(() => btn.innerText = "Guardar Cambios", 2000);
    }

    function downloadFullCSV() {
        db.ref('/historial').once('value').then(snap => {
            let csv = "Fecha,Hora,Temp_DHT11_Digital(C),Temp_Termistor_Analogo(C),Humedad(%),Lluvia_Total(mm)\n";
            snap.forEach(child => {
                const d = child.val();
                if(d.fecha) {
                    const dateObj = new Date(d.fecha);
                    const date = dateObj.toLocaleDateString("es-MX");
                    const time = dateObj.toLocaleTimeString("es-MX");
                    
                    let t_dht = d.t_dht !== undefined ? d.t_dht : (d.temperatura || "");
                    let t_ntc = d.t_termistor !== undefined ? d.t_termistor : "";
                    let h = d.humedad !== undefined ? d.humedad : "";
                    let r = d.mm_total !== undefined ? d.mm_total : 0;
                    
                    csv += `${date},${time},${t_dht},${t_ntc},${h},${r}\n`;
                }
            });
            downloadFile(csv, "Reporte_Completo_Estacion.csv");
        });
    }

    function downloadFile(content, fileName) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([content], {type:'text/csv'}));
        link.download = fileName;
        link.click();
    }

    document.addEventListener('DOMContentLoaded', initCharts);
</script>

</body>
</html>
